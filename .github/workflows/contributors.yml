name: Update Contributors

on:
  push:
    branches: [main]
  schedule:
    # Update contributor stats fortnightly at 00:00 UTC
    - cron: '0 0 */14 * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-contributors:
    name: Update Contributor Statistics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm init -y
          npm install @octokit/rest --save

      - name: Generate contributor statistics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > generate-stats.js << 'EOF'
          const fs = require('fs');
          const { Octokit } = require('@octokit/rest');

          async function generateStats() {
            
            const octokit = new Octokit({
              auth: process.env.GITHUB_TOKEN,
            });

            const owner = '${{ github.repository_owner }}';
            const repo = '${{ github.event.repository.name }}';

            try {
              // Get repository information
              const { data: repoData } = await octokit.rest.repos.get({
                owner,
                repo,
              });
              
              // Get contributors
              const { data: contributors } = await octokit.rest.repos.listContributors({
                owner,
                repo,
                per_page: 100,
              });
              
              // Get commit statistics using listCommits endpoint
              let allCommits = [];
              let page = 1;
              let commits;
              
              do {
                commits = await octokit.rest.repos.listCommits({
                  owner,
                  repo,
                  per_page: 100,
                  page: page
                });
                allCommits = allCommits.concat(commits.data);
                page++;
              } while (commits.data.length === 100 && page <= 10); // Limit to 1000 commits to avoid rate limits
              
              const totalCommits = allCommits.length;
              
              // Get latest releases
              let releases = [];
              try {
                const { data: releasesData } = await octokit.rest.repos.listReleases({
                  owner,
                  repo,
                  per_page: 5,
                });
                releases = releasesData;
              } catch (e) {
                console.log('No releases found');
              }
              
              const stats = {
                lastUpdated: new Date().toISOString(),
                repository: {
                  name: repoData.name,
                  fullName: repoData.full_name,
                  description: repoData.description,
                  stars: repoData.stargazers_count,
                  forks: repoData.forks_count,
                  watchers: repoData.watchers_count,
                  openIssues: repoData.open_issues_count,
                  language: repoData.language,
                  createdAt: repoData.created_at,
                  updatedAt: repoData.updated_at,
                  size: repoData.size,
                },
                statistics: {
                  totalCommits,
                  totalContributors: contributors.length,
                  totalReleases: releases.length,
                },
                contributors: contributors.map(contributor => ({
                  login: contributor.login,
                  id: contributor.id,
                  avatarUrl: contributor.avatar_url,
                  url: contributor.html_url,
                  contributions: contributor.contributions,
                  type: contributor.type,
                })),
                releases: releases.map(release => ({
                  name: release.name,
                  tagName: release.tag_name,
                  publishedAt: release.published_at,
                  url: release.html_url,
                  prerelease: release.prerelease,
                  draft: release.draft,
                })),
                commitActivity: [], // We're not using this anymore
              };
              
              // Ensure docs directory exists
              if (!fs.existsSync('docs')) {
                fs.mkdirSync('docs');
              }
              if (!fs.existsSync('docs/stats')) {
                fs.mkdirSync('docs/stats');
              }
              
              // Write statistics
              fs.writeFileSync('docs/stats/repository.json', JSON.stringify(stats, null, 2));
              
              // Generate contributor page
              const contributorHtml = generateContributorPage(stats);
              fs.writeFileSync('docs/contributors.html', contributorHtml);
              
              // Generate stats page
              const statsHtml = generateStatsPage(stats);
              fs.writeFileSync('docs/stats.html', statsHtml);
              
              console.log('âœ… Statistics generated successfully');
              console.log(`Total contributors: ${stats.statistics.totalContributors}`);
              console.log(`Total commits: ${stats.statistics.totalCommits}`);
              console.log(`Repository stars: ${stats.repository.stars}`);
              
            } catch (error) {
              console.error('Error generating statistics:', error);
              process.exit(1);
            }
          }

          function generateContributorPage(stats) {
            return `<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Contributors - AI Email Marketing System</title>
              <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
              <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
          </head>
          <body class="bg-gray-50">
              <nav class="bg-white shadow-lg">
                  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                      <div class="flex justify-between h-16">
                          <div class="flex items-center">
                              <h1 class="text-xl font-bold text-blue-600">AI Email Marketing</h1>
                          </div>
                          <div class="flex items-center space-x-4">
                              <a href="./index.html" class="text-gray-700 hover:text-blue-600">Home</a>
                              <a href="https://github.com/${stats.repository.fullName}" class="text-gray-700 hover:text-blue-600">
                                  <i class="fab fa-github"></i> GitHub
                              </a>
                          </div>
                      </div>
                  </div>
              </nav>
              
              <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                  <div class="text-center mb-12">
                      <h1 class="text-4xl font-bold text-gray-900 mb-4">Contributors</h1>
                      <p class="text-xl text-gray-600">Amazing people who make this project possible</p>
                      <div class="mt-6 flex justify-center space-x-8">
                          <div class="text-center">
                              <div class="text-3xl font-bold text-blue-600">${stats.statistics.totalContributors}</div>
                              <div class="text-gray-600">Contributors</div>
                          </div>
                          <div class="text-center">
                              <div class="text-3xl font-bold text-green-600">${stats.statistics.totalCommits}</div>
                              <div class="text-gray-600">Commits</div>
                          </div>
                          <div class="text-center">
                              <div class="text-3xl font-bold text-purple-600">${stats.repository.stars}</div>
                              <div class="text-gray-600">Stars</div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="mb-8">
                      <div class="bg-white rounded-lg shadow-lg p-6">
                          <h2 class="text-2xl font-semibold mb-6">Project Founder</h2>
                          <div class="flex items-center space-x-6 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                              <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                  MI
                              </div>
                              <div class="flex-1">
                                  <h3 class="text-2xl font-semibold">Muhammad Ismail</h3>
                                  <p class="text-gray-600">Founder of AimNovo.com & AimNexus.ai</p>
                                  <p class="text-sm text-gray-500">ismail@aimnovo.com</p>
                                  <div class="flex space-x-2 mt-3">
                                      <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">Project Creator</span>
                                      <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">Lead Developer</span>
                                      <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">Architect</span>
                                  </div>
                              </div>
                              <div class="text-right">
                                  <div class="text-2xl font-bold text-gray-700">${stats.contributors.find(c => c.login.toLowerCase().includes('ismail') || c.login.toLowerCase().includes('muhammad') || c.login.toLowerCase().includes('quaid'))?.contributions || 'N/A'}</div>
                                  <div class="text-sm text-gray-500">Contributions</div>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                      ${stats.contributors.map(contributor => `
                          <div class="bg-white rounded-lg shadow-lg p-6 text-center hover:shadow-xl transition-shadow">
                              <img src="${contributor.avatarUrl}" alt="${contributor.login}" 
                                   class="w-20 h-20 rounded-full mx-auto mb-4">
                              <h3 class="text-xl font-semibold mb-2">${contributor.login}</h3>
                              <div class="text-2xl font-bold text-blue-600 mb-2">${contributor.contributions}</div>
                              <div class="text-sm text-gray-600 mb-4">contributions</div>
                              <a href="${contributor.url}" 
                                 class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                  <i class="fab fa-github mr-2"></i>View Profile
                              </a>
                          </div>
                      `).join('')}
                  </div>
                  
                  <div class="mt-12 text-center">
                      <h2 class="text-2xl font-semibold mb-4">Want to contribute?</h2>
                      <p class="text-gray-600 mb-6">We welcome contributions from developers around the world!</p>
                      <div class="flex flex-col sm:flex-row gap-4 justify-center">
                          <a href="https://github.com/${stats.repository.fullName}/fork" 
                             class="inline-flex items-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                              <i class="fas fa-code-branch mr-2"></i>Fork the Project
                          </a>
                          <a href="https://github.com/${stats.repository.fullName}/blob/main/CONTRIBUTING.md" 
                             class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                              <i class="fas fa-book mr-2"></i>Contributing Guide
                          </a>
                          <a href="https://github.com/${stats.repository.fullName}/issues/new" 
                             class="inline-flex items-center px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">
                              <i class="fas fa-plus mr-2"></i>Report Issue
                          </a>
                      </div>
                  </div>
              </div>
          </body>
          </html>`;
          }

          function generateStatsPage(stats) {
            return `<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Statistics - AI Email Marketing System</title>
              <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
              <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          </head>
          <body class="bg-gray-50">
              <nav class="bg-white shadow-lg">
                  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                      <div class="flex justify-between h-16">
                          <div class="flex items-center">
                              <h1 class="text-xl font-bold text-blue-600">AI Email Marketing</h1>
                          </div>
                          <div class="flex items-center space-x-4">
                              <a href="./index.html" class="text-gray-700 hover:text-blue-600">Home</a>
                              <a href="./contributors.html" class="text-gray-700 hover:text-blue-600">Contributors</a>
                              <a href="https://github.com/${stats.repository.fullName}" class="text-gray-700 hover:text-blue-600">
                                  <i class="fab fa-github"></i> GitHub
                              </a>
                          </div>
                      </div>
                  </div>
              </nav>
              
              <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                  <div class="text-center mb-12">
                      <h1 class="text-4xl font-bold text-gray-900 mb-4">Project Statistics</h1>
                      <p class="text-xl text-gray-600">Real-time analytics and insights</p>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                      <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                          <div class="text-3xl font-bold text-blue-600 mb-2">${stats.repository.stars}</div>
                          <div class="text-gray-600">Stars</div>
                          <div class="text-sm text-gray-500 mt-1">
                              <i class="fas fa-star text-yellow-400"></i> GitHub Stars
                          </div>
                      </div>
                      
                      <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                          <div class="text-3xl font-bold text-green-600 mb-2">${stats.repository.forks}</div>
                          <div class="text-gray-600">Forks</div>
                          <div class="text-sm text-gray-500 mt-1">
                              <i class="fas fa-code-branch text-green-400"></i> Repository Forks
                          </div>
                      </div>
                      
                      <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                          <div class="text-3xl font-bold text-purple-600 mb-2">${stats.statistics.totalCommits}</div>
                          <div class="text-gray-600">Commits</div>
                          <div class="text-sm text-gray-500 mt-1">
                              <i class="fas fa-code text-purple-400"></i> Total Commits
                          </div>
                      </div>
                      
                      <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                          <div class="text-3xl font-bold text-red-600 mb-2">${stats.statistics.totalContributors}</div>
                          <div class="text-gray-600">Contributors</div>
                          <div class="text-sm text-gray-500 mt-1">
                              <i class="fas fa-users text-red-400"></i> Active Contributors
                          </div>
                      </div>
                  </div>
                  
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                      <div class="bg-white rounded-lg shadow-lg p-6">
                          <h2 class="text-xl font-semibold mb-4">Repository Information</h2>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <div>
                                  <h3 class="font-semibold text-gray-700 mb-2">Details</h3>
                                  <ul class="space-y-2 text-gray-600">
                                      <li><strong>Name:</strong> ${stats.repository.name}</li>
                                      <li><strong>Language:</strong> ${stats.repository.language || 'Multiple'}</li>
                                      <li><strong>Size:</strong> ${(stats.repository.size / 1024).toFixed(1)} MB</li>
                                      <li><strong>Created:</strong> ${new Date(stats.repository.createdAt).toLocaleDateString()}</li>
                                  </ul>
                              </div>
                              <div>
                                  <h3 class="font-semibold text-gray-700 mb-2">Activity</h3>
                                  <ul class="space-y-2 text-gray-600">
                                      <li><strong>Open Issues:</strong> ${stats.repository.openIssues}</li>
                                      <li><strong>Watchers:</strong> ${stats.repository.watchers}</li>
                                      <li><strong>Releases:</strong> ${stats.statistics.totalReleases}</li>
                                      <li><strong>Last Updated:</strong> ${new Date(stats.repository.updatedAt).toLocaleDateString()}</li>
                                  </ul>
                              </div>
                          </div>
                      </div>
                      
                      <div class="bg-white rounded-lg shadow-lg p-6">
                          <h2 class="text-xl font-semibold mb-4">Contributor Distribution</h2>
                          <canvas id="contributorChart" width="400" height="200"></canvas>
                      </div>
                  </div>
              </div>
              
              <script>
                  // Contributor Chart
                  const contributorData = ${JSON.stringify(stats.contributors.slice(0, 10))};
                  const ctx2 = document.getElementById('contributorChart').getContext('2d');
                  new Chart(ctx2, {
                      type: 'doughnut',
                      data: {
                          labels: contributorData.map(c => c.login),
                          datasets: [{
                              data: contributorData.map(c => c.contributions),
                              backgroundColor: [
                                  '#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EF4444',
                                  '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1'
                              ]
                          }]
                      },
                      options: {
                          responsive: true
                      }
                  });
              </script>
          </body>
          </html>`;
          }

          // Call the async function
          generateStats().catch(error => {
            console.error('Error in generateStats:', error);
            process.exit(1);
          });
          EOF

          node generate-stats.js

      - name: Create README badges
        run: |
          mkdir -p docs/badges

          # Get latest stats
          CONTRIBUTORS=$(jq -r '.statistics.totalContributors' docs/stats/repository.json)
          COMMITS=$(jq -r '.statistics.totalCommits' docs/stats/repository.json)
          STARS=$(jq -r '.repository.stars' docs/stats/repository.json)
          FORKS=$(jq -r '.repository.forks' docs/stats/repository.json)

          # Generate badge URLs
          cat > docs/badges/README.md << 'EOF'
          # Project Badges

          ![Contributors](https://img.shields.io/badge/contributors-${CONTRIBUTORS}-blue)
          ![Commits](https://img.shields.io/badge/commits-${COMMITS}-green)
          ![Stars](https://img.shields.io/badge/stars-${STARS}-yellow)
          ![Forks](https://img.shields.io/badge/forks-${FORKS}-red)
          ![License](https://img.shields.io/badge/license-MIT-brightgreen)
          ![Commercial Use](https://img.shields.io/badge/commercial%20use-allowed-green)

          ## Usage in README

          ```markdown
          ![Contributors](https://img.shields.io/badge/contributors-${CONTRIBUTORS}-blue)
          ![Commits](https://img.shields.io/badge/commits-${COMMITS}-green)
          ![Stars](https://img.shields.io/badge/stars-${STARS}-yellow)
          ![Forks](https://img.shields.io/badge/forks-${FORKS}-red)
          ```
          EOF

      - name: Update main index.html with latest stats
        run: |
          # Update the main page with latest statistics
          CONTRIBUTORS=$(jq -r '.statistics.totalContributors' docs/stats/repository.json)
          COMMITS=$(jq -r '.statistics.totalCommits' docs/stats/repository.json)

          sed -i "s/id=\"contributor-count\">-/id=\"contributor-count\">${CONTRIBUTORS}/g" docs/index.html
          sed -i "s/id=\"commit-count\">-/id=\"commit-count\">${COMMITS}/g" docs/index.html

      # Note: Files are updated but not committed to prevent auto-generated commits
      # The updated files will be available for the deploy-pages workflow
      - name: Archive updated documentation
        uses: actions/upload-artifact@v4
        with:
          name: updated-docs
          path: docs/
          retention-days: 1
